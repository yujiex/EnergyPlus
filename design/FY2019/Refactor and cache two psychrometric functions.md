# Refactor and cache two psychrometric functions

Xuan Luo, Tianzhen Hong

Lawrence Berkeley National Laboratory

July 25, 2019 

## Justification for Feature Update

The feature is to convert the funtion `PsyTsatFnHPb` from Fortran code to C++ code, and use caching for two psychrometric funtions - `PsyTsatFnHPb` & `PsyTsatFnPb`.

The caching helps achieve run time performance gain but may trigger some small differences in the reported results. Table 1 summarizes the regression diffs of the two psychrometric functions. The summary is based on the regression test results with 623 EnergyPlus test files. The max diff in annual energy/facility report indicates the maximum relative difference in the summary tables, out of the total 623 tests. The math diffs indicate the differences in the reported variables and meters by hour or by time step. The tables diffs indicate the differences in the final report tables.

**Table 1. Regression diffs of two psychrometric functions - annual**

| ﻿Trade off flags       | Number of tests have large math diffs | Number of tests have large table diffs | Annual Site EUI   |                                | Annual Energy Meters Entire Facility - Electricity |                                | Annual Energy Meters Entire Facility - Gas |                                | Annual Energy Meters Entire Facility - Cooling |                                | Annual Energy Meters Entire Facility - Water |                                | Annual Energy Meters Entire Facility - Other |                                |
|-----------------------|---------------------------------------|----------------------------------------|-------------------|--------------------------------|----------------------------------------------------|--------------------------------|--------------------------------------------|--------------------------------|------------------------------------------------|--------------------------------|----------------------------------------------|--------------------------------|----------------------------------------------|--------------------------------|
|                       |                                       |                                        | Max relative diff | # test cases have diff > 0.01% | Max relative diff                                  | # test cases have diff > 0.01% | Max relative diff                          | # test cases have diff > 0.01% | Max relative diff                              | # test cases have diff > 0.01% | Max relative diff                            | # test cases have diff > 0.01% | Max relative diff                            | # test cases have diff > 0.01% |
| EP_cache_PsyTsatFnPb  | 43                                    | 23                                     | 0.10%             | 7                              | 0.11%                                              | 7                              | 0.02%                                      | 2                              | 0.02%                                          | 3                              | 0.23%                                        | 12                             | 0.09%                                        | 6                              |
| EP_cache_PsyTsatFnHPb | 57                                    | 34                                     | 0.06%             | 10                             | 0.06%                                              | 9                              | 0.02%                                      | 3                              | 0.02%                                          | 5                              | 0.18%                                        | 12                             | 0.09%                                        | 8                              |

The regression diffs of the peak results are summarized in Table 2.

**Table 2. Regression diffs of two psychrometric functions - peak**

| ﻿Trade off flags       | Annual Energy Meters Entire Facility - Electricity |                                | Annual Energy Meters Entire Facility - Gas |                                | Annual Energy Meters Entire Facility - Cooling |                                | Annual Energy Meters Entire Facility - Water |                                | Annual Energy Meters Entire Facility - Other |                                |
|-----------------------|----------------------------------------------------|--------------------------------|--------------------------------------------|--------------------------------|------------------------------------------------|--------------------------------|----------------------------------------------|--------------------------------|----------------------------------------------|--------------------------------|
|                       | Max relative diff                                  | # test cases have diff > 0.01% | Max relative diff                          | # test cases have diff > 0.01% | Max relative diff                              | # test cases have diff > 0.01% | Max relative diff                            | # test cases have diff > 0.01% | Max relative diff                            | # test cases have diff > 0.01% |
| EP_cache_PsyTsatFnPb  | 4.30%                                              | 2                              | 0.47%                                      | 1                              | 0.12%                                          | 1                              | N/A                                          | 0                              | 0.72                                         | 2                              |
| EP_cache_PsyTsatFnHPb | 4.20%                                              | 3                              | 0.31%                                      | 1                              | 0.04%                                          | 2                              | N/A                                          | 0                              | 0.60%                                        | 2                              |

We further took some example files and analyzed where the big diffs show in each test case. The big deviations mainly appear in fields including heating and cooling capacity, convergence information, annual peak (minimum and maximum) values and setpoint not met (Table 3). This indicates that at some extreme conditions, minor (10^-16) precision difference in the calculation of psychrometric function can cause cumulative effect in simulation results.

For example, in Ice Thermal Storage Calculation, the `Ice Thermal Storage Requested Load` is calculated by `Design mass flow rate * Cp of glycol * (Inlet temperature – Setpoint temperature)`. In the `5ZoneIceStorge.idf` test case, the design mass flow rate multiplied by the specific heat is at the magnitude of 10^4 and the precision diff of temperature is also magnified by this amount. In general, when calculating water flow rate in small building with the unit of m^3/s, the absolute flow rate value can be relatively small, and the deviation of the diff of two temperatures (e.g. inlet and outlet temperature) accounts for greater relative difference in loads. When calculating air flow rate in large buildings, the absolute value of flow rate can be large and the precision deviation of two temperatures diffs can account for greater absolute difference in loads.


**Table 3. Regression diffs of two psychrometric functions - examples**

| ﻿                                           | Table big diffs                                                                                                                                                                          | ESO big diffs                                                                                                                                                                                                                                                                                                                            | MTR big diffs                                                                                                                                                                                                                                               |
|--------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 5ZoneCoolBeam                              | Warmup Convergence Information                                                                                                                                                           | N/A                                                                                                                                                                                                                                                                                                                                      | N/A                                                                                                                                                                                                                                                         |
| 5ZoneCoolingPanelBaseboard                 | Annual and Peak Values - Electricity; Annual and Peak Values - Gas; Annual and Peak Values - Cooling; Annual and Peak Values - Other                                                     | Max absolute diff: 2250.1488349, field: CENTRAL CHILLER:Chiller Evaporator Cooling Rate [W](Hourly), time:  07/21  01:00:00, relative: 0.290877294867;Max relative diff: 1.0, field: MAIN HEATING COIL 1:Heating Coil Heating Rate [W](Hourly), time:  07/21  06:00:00, absolute: 694.942999853                                          | Max absolute diff: 5825448.88749, field: Gas:Facility [J](Monthly), time: July, relative: 0.0108159291299;Max relative diff: 0.0108159291299, field: Gas:Facility [J](Monthly), time: July, absolute: 5825448.88749                                         |
| 5ZoneElectricBaseboard                     | Annual and Peak Values - Electricity;Annual and Peak Values - Other                                                                                                                      | N/A                                                                                                                                                                                                                                                                                                                                      | N/A                                                                                                                                                                                                                                                         |
| 5ZoneIceStorage                            | Plant Loop Coincident Design Fluid Flow Rate Adjustments                                                                                                                                 | N/A                                                                                                                                                                                                                                                                                                                                      | N/A                                                                                                                                                                                                                                                         |
| 5ZoneWaterCooled_Baseboard                 | Annual and Peak Values - Water;Annual and Peak Values - Other                                                                                                                            | Max absolute diff: 3910.55749028, field: CENTRAL CHILLER:Chiller Evaporator Cooling Rate [W](Hourly), time:  07/21  24:00:00, relative: 0.489140289909;Max relative diff: 0.489140289909, field: CENTRAL CHILLER:Chiller Evaporator Cooling Rate [W](Hourly), time:  07/21  24:00:00, absolute: 3910.55749028                            | Max absolute diff: 3781493.32856, field: Electricity:Facility [J](Monthly), time: July, relative: 0.003822818262;Max relative diff: 0.0065249669738, field: Electricity:Plant [J](Monthly), time: July, absolute: 3781493.14183                             |
| 5ZoneWaterCooled_HighRHControl             | Warmup Convergence Information;Annual and Peak Values - Electricity;Annual and Peak Values - other                                                                                       | Max absolute diff: 754.535946383, field: MAIN COOLING COIL 1:Cooling Coil Total Cooling Rate [W](Hourly), time:  07/21  06:00:00, relative: 0.114245738677; Max relative diff: 0.239215392434, field: MAIN HEATING COIL 1:Heating Coil Heating Rate [W](Hourly), time:  07/21  06:00:00, absolute: 724.02837944                          | Max absolute diff: 3163512.97647, field: Gas:Facility [J](Monthly), time: July, relative: 0.00478605484346; Max relative diff: 0.00478605484346, field: Gas:Facility [J](Monthly), time: July, absolute: 3163512.97647                                      |
| ASHRAE9012016_Hospital_Denver              | Comfort and Setpoint Not Met Summary                                                                                                                                                     | Max absolute diff: 1101315204.01, field: Electricity:Facility [J](Monthly), time: July, relative: 0.0110115007204;Max relative diff: 0.0110115007204, field: Electricity:Facility [J](Monthly), time: July, absolute: 1101315204.01                                                                                                      | Max absolute diff: 1101315204.01, field: Electricity:Facility [J](Monthly), time:  07/21  24:00:00, relative: 0.0110115007204;Max relative diff: 0.0110115007204, field: Electricity:Facility [J](Monthly), time:  07/21  24:00:00, absolute: 1101315204.01 |
| ASHRAE9012016_OfficeLarge_Denver           | Time Setpoint Not Met                                                                                                                                                                    | N/A                                                                                                                                                                                                                                                                                                                                      | N/A                                                                                                                                                                                                                                                         |
| CentralChillerHeaterSystem_Cooling_Heating | Comfort and Setpoint Not Met Summary;Environment:WarmupDays;Warmup Convergence Information;Annual and Peak Values - Electricity;Annual and Peak Values - Other;EAp2-2. Advisory Messages | Max absolute diff: 943291.539437, field: CHILLERBANK:Chiller Heater System Cooling Electric Energy [J](TimeStep), time:  07/21  07:40:00, relative: 0.160657554291;Max relative diff: 999, field: VERTICAL GROUND HEAT EXCHANGER:Ground Heat Exchanger Heat Transfer Rate [W](TimeStep), time:  07/21  07:40:00, absolute: 49963.5234817 | Max absolute diff: 3865279.15555, field: Electricity:Plant [J](Monthly), time: July, relative: 0.00856142803732;Max relative diff: 0.00856142803732, field: Electricity:Plant [J](Monthly), time: July, absolute: 3865279.15555                             |
| HeatPumpWaterHeater                        | Warmup Convergence Information;Annual and Peak Values - Electricity; Annual and Peak Values - Water; Annual and Peak Values - Cooling; Annual and Peak Values - Other                    | Max absolute diff: 965.026314929, field: MAIN COOLING COIL 1:Cooling Coil Total Cooling Rate [W](Hourly), time:  07/21  05:00:00, relative: 0.143084278282;Max relative diff: 0.296270953432, field: HPWHPLANTDXCOIL:Cooling Coil Total Cooling Rate [W](Hourly), time:  07/21  03:00:00, absolute: 409.557737679                        | Max absolute diff: 6079154.87704, field: Electricity:Facility [J](Monthly), time: July, relative: 0.00520247500374;Max relative diff: 0.00791127718368, field: Electricity:Plant [J](Monthly), time: July, absolute: 6033670.18734                          |

